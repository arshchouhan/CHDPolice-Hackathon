<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .risk-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .risk-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: rgb(239, 68, 68);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .risk-medium {
            background-color: rgba(245, 158, 11, 0.2);
            color: rgb(245, 158, 11);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .risk-low {
            background-color: rgba(16, 185, 129, 0.2);
            color: rgb(16, 185, 129);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .progress-fill-high {
            background-color: rgb(239, 68, 68);
        }
        .progress-fill-medium {
            background-color: rgb(245, 158, 11);
        }
        .progress-fill-low {
            background-color: rgb(16, 185, 129);
        }
        .tab-active {
            border-bottom: 2px solid rgb(59, 130, 246);
            color: rgb(59, 130, 246);
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .analysis-layer {
            display: none;
        }
        .analysis-layer.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900">
    <!-- Background overlay with subtle pattern -->
    <div class="fixed inset-0 z-0 opacity-20" style="background-image: url('https://images.unsplash.com/photo-1544197150-b99a580bb7a8?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'); background-size: cover;"></div>
    <!-- Blue overlay for depth -->
    <div class="fixed inset-0 z-0 bg-blue-900 opacity-10"></div>
    
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white/10 backdrop-blur-lg p-6 rounded-lg flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-white">Processing your request...</p>
        </div>
    </div>
    
    <!-- Gmail Authorization Modal -->
    <div id="gmailAuthModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden">
            <div class="border-b border-gray-700 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-medium text-white">Connect Gmail Account</h3>
                <button id="closeModal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="text-gray-300 text-sm">
                    <p class="mb-4">By connecting your Gmail account, you authorize our application to:</p>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>Scan your emails for potential phishing threats</li>
                        <li>Analyze email headers and content for security risks</li>
                        <li>Detect suspicious links and attachments</li>
                        <li>Provide real-time alerts about dangerous emails</li>
                    </ul>
                    <p class="mt-4 text-blue-300"><i class="fas fa-lock mr-2"></i>We value your privacy and will never share your data with third parties.</p>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="authorizeGmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center">
                        <i class="fab fa-google mr-2"></i> Connect Gmail Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Container -->
    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- Top Navigation -->
        <nav class="bg-white/10 backdrop-blur-lg rounded-lg p-4 mb-8 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-blue-600 p-2 rounded-lg shadow-lg">
                    <i class="fas fa-shield-alt text-white"></i>
                </div>
                <span class="text-white font-bold">CHD Police Email Security</span>
            </div>
            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-1 text-gray-300 text-sm">
                    <i class="fas fa-user-circle text-blue-400"></i>
                    <span id="userEmail">user@example.com</span>
                </div>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Email Connection Status -->
        <div id="emailConnectionStatus" class="bg-yellow-600/20 backdrop-blur-lg rounded-lg p-6 mb-8 border border-yellow-600/30">
            <!-- Not Connected State -->
            <div id="gmailNotConnectedSection" class="flex items-start space-x-4">
                <div class="bg-yellow-500/20 p-3 rounded-full">
                    <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-1">Email Account Not Connected</h3>
                    <p class="text-gray-300 mb-4">Connect your Gmail account to enable email phishing protection.</p>
                    <button id="connectGmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center">
                        <i class="fab fa-google mr-2"></i> Connect Gmail Account
                    </button>
                </div>
            </div>
            
            <!-- Connected State (Hidden by default) -->
            <div id="gmailConnectedSection" class="hidden flex items-start space-x-4">
                <div class="bg-green-500/20 p-3 rounded-full">
                    <i class="fas fa-check-circle text-green-400 text-xl"></i>
                </div>
                <div class="flex-grow">
                    <h3 class="text-lg font-semibold text-white mb-1">Gmail Account Connected</h3>
                    <p class="text-gray-300 mb-4">Your account <span id="connectedEmail" class="text-blue-300 font-medium">user@example.com</span> is now protected.</p>
                    <div class="flex flex-wrap gap-3">
                        <button id="scanNowBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-xs font-medium transition duration-150 ease-in-out flex items-center">
                            <i class="fas fa-shield-alt mr-2"></i> Scan Now
                        </button>
                        <button id="syncEmailsBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-xs font-medium transition duration-150 ease-in-out flex items-center">
                            <i class="fas fa-sync mr-2"></i> Sync Emails
                        </button>
                        <button id="disconnectGmailBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-md text-xs font-medium transition duration-150 ease-in-out flex items-center">
                            <i class="fas fa-unlink mr-2"></i> Disconnect
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Email Analysis Dashboard (Hidden until email is connected) -->
        <div id="emailAnalysisDashboard" class="hidden">
            <!-- Email Selection and Summary -->
            <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-white">Email Analysis</h2>
                        <p class="text-gray-400 text-sm">Detailed breakdown of potential threats</p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <select id="emailSelector" class="bg-gray-800 text-white border border-gray-700 rounded-md px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="email1">Suspicious PayPal Email (May 17, 2025)</option>
                            <option value="email2">Account Verification (May 16, 2025)</option>
                            <option value="email3">Your Invoice #INV-2025-0517 (May 15, 2025)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Overall Risk Score -->
                <div class="bg-gray-800/50 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <div class="bg-red-500/20 p-2 rounded-full mr-3">
                                <i class="fas fa-exclamation-triangle text-red-500"></i>
                            </div>
                            <div>
                                <h3 class="text-white font-semibold">High Risk Email Detected</h3>
                                <p class="text-gray-400 text-sm">From: "PayPal Service" &lt;service.paypal@suspicious-domain.com&gt;</p>
                            </div>
                        </div>
                        <div class="risk-badge risk-high">
                            <i class="fas fa-shield-alt mr-1"></i> 80/100 Risk
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill-high" style="width: 80%"></div>
                    </div>
                </div>
                
                <!-- Analysis Tabs -->
                <div class="border-b border-gray-700 mb-6">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                        <li class="mr-2">
                            <button class="tab-button tab-active inline-block p-4 text-blue-500 rounded-t-lg border-b-2 border-blue-500" data-target="headerAnalysis">Header Analysis</button>
                        </li>
                        <li class="mr-2">
                            <button class="tab-button inline-block p-4 text-gray-400 hover:text-gray-300 rounded-t-lg" data-target="contentAnalysis">Content Analysis</button>
                        </li>
                        <li class="mr-2">
                            <button class="tab-button inline-block p-4 text-gray-400 hover:text-gray-300 rounded-t-lg" data-target="metadataAnalysis">Metadata</button>
                        </li>
                        <li>
                            <button class="tab-button inline-block p-4 text-gray-400 hover:text-gray-300 rounded-t-lg" data-target="attachmentAnalysis">Attachments & URLs</button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Analysis Layers -->
            <div class="analysis-layers mb-8">
                <!-- Header Analysis Layer -->
                <div id="headerAnalysis" class="analysis-layer active">
                    <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-white">Header Analysis</h3>
                            <div class="risk-badge risk-high">
                                <i class="fas fa-shield-alt mr-1"></i> 22/25 Risk
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Left Column -->
                            <div class="space-y-4">
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">SPF Check</h4>
                                            <p class="text-gray-400 text-sm">Sender Policy Framework verification</p>
                                        </div>
                                        <span class="bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded font-medium">Fail</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">DKIM Validation</h4>
                                            <p class="text-gray-400 text-sm">DomainKeys Identified Mail signature</p>
                                        </div>
                                        <span class="bg-green-500/20 text-green-500 text-xs px-2 py-1 rounded font-medium">Pass</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">DMARC Policy</h4>
                                            <p class="text-gray-400 text-sm">Domain-based Message Authentication</p>
                                        </div>
                                        <span class="bg-yellow-500/20 text-yellow-500 text-xs px-2 py-1 rounded font-medium">Not Found</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">From vs Reply-To</h4>
                                            <p class="text-gray-400 text-sm">Check for mismatched email addresses</p>
                                        </div>
                                        <span class="bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded font-medium">Mismatch</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="space-y-4">
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">Sender IP Geolocation</h4>
                                            <p class="text-gray-400 text-sm">Origin of the email server</p>
                                        </div>
                                        <span class="bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded font-medium">Nigeria (dY╪3dY╪¬)</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">IP Reputation</h4>
                                            <p class="text-gray-400 text-sm">Blacklist status of sender IP</p>
                                        </div>
                                        <span class="bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded font-medium">Flagged by 2/3 RBLs</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4 h-full flex flex-col">
                                    <h4 class="text-white font-medium mb-2">Recommended Actions</h4>
                                    <div class="flex flex-col space-y-2 mt-auto">
                                        <button class="bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-2 rounded-md transition duration-150 ease-in-out flex items-center justify-center">
                                            <i class="fas fa-trash-alt mr-2"></i> Delete Email
                                        </button>
                                        <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-md transition duration-150 ease-in-out flex items-center justify-center">
                                            <i class="fas fa-file-code mr-2"></i> View Raw Headers
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // Enhanced BASE_URL determination with better logging and error handling
        const getBaseUrl = () => {
            const hostname = window.location.hostname;
            const origin = window.location.origin;
            let baseUrl;
            
            // Determine base URL based on hostname
            if (hostname.includes('vercel.app')) {
                baseUrl = origin; // Use full origin for Vercel deployments
                console.log('Detected Vercel environment');
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                baseUrl = 'http://localhost:3000';
                console.log('Detected local development environment');
            } else if (hostname.includes('onrender.com')) {
                baseUrl = 'https://email-detection-api.onrender.com';
                console.log('Detected Render environment');
            } else {
                baseUrl = origin; // Default to current origin for unknown environments
                console.log('Using default environment detection, origin:', origin);
            }
            
            console.log('BASE_URL set to:', baseUrl);
            return baseUrl;
        };
        
        // Initialize BASE_URL
        const BASE_URL = getBaseUrl();
        
        // Show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
        }
        
        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('flex');
        }
        
        // Improved error handling and user feedback
        function showError(message, details = null) {
            // Create or update error notification element
            let errorNotification = document.getElementById('errorNotification');
            
            if (!errorNotification) {
                errorNotification = document.createElement('div');
                errorNotification.id = 'errorNotification';
                errorNotification.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-3 rounded shadow-lg z-50 flex items-start';
                document.body.appendChild(errorNotification);
            }
            
            errorNotification.innerHTML = `
                <div class="mr-3">
                    <i class="fas fa-exclamation-circle text-xl"></i>
                </div>
                <div>
                    <h4 class="font-bold">${message}</h4>
                    ${details ? `<p class="text-sm">${details}</p>` : ''}
                    <button class="text-xs underline mt-1" onclick="document.getElementById('errorNotification').remove()">Dismiss</button>
                </div>
            `;
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                if (document.getElementById('errorNotification')) {
                    document.getElementById('errorNotification').remove();
                }
            }, 8000);
            
            // Also log to console for debugging
            console.error(message, details);
        }
        
        // Success notification function
        function showSuccessNotification(title, message) {
            let successNotification = document.getElementById('successNotification');
            
            if (!successNotification) {
                successNotification = document.createElement('div');
                successNotification.id = 'successNotification';
                successNotification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-3 rounded shadow-lg z-50 flex items-start';
                document.body.appendChild(successNotification);
            }
            
            successNotification.innerHTML = `
                <div class="mr-3">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div>
                    <h4 class="font-bold">${title}</h4>
                    <p class="text-sm">${message}</p>
                    <button class="text-xs underline mt-1" onclick="document.getElementById('successNotification').remove()">Dismiss</button>
                </div>
            `;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (document.getElementById('successNotification')) {
                    document.getElementById('successNotification').remove();
                }
            }, 5000);
        }
        
        // Show Gmail authorization modal
        function showGmailAuthModal() {
            document.getElementById('gmailAuthModal').classList.remove('hidden');
            document.getElementById('gmailAuthModal').classList.add('flex');
        }
        
        // Hide Gmail authorization modal
        function hideGmailAuthModal() {
            document.getElementById('gmailAuthModal').classList.add('hidden');
            document.getElementById('gmailAuthModal').classList.remove('flex');
        }
        
        // Function to update Gmail connection status in UI with robust error handling
        function updateGmailConnectionStatus(isConnected, email) {
            console.log('Updating Gmail connection status:', isConnected ? 'Connected' : 'Not connected', email || '');
            
            try {
                // Get the elements with null checks
                const connectedSection = document.getElementById('gmailConnectedSection');
                const notConnectedSection = document.getElementById('gmailNotConnectedSection');
                const connectedEmailElement = document.getElementById('connectedEmail');
                
                // Log element presence for debugging
                console.log('UI Elements found:', {
                    connectedSection: !!connectedSection,
                    notConnectedSection: !!notConnectedSection,
                    connectedEmailElement: !!connectedEmailElement
                });
                
                if (isConnected) {
                    // Update localStorage to persist connection state
                    localStorage.setItem('gmailConnected', 'true');
                    if (email) localStorage.setItem('gmailEmail', email);
                    
                    // Update UI elements if they exist
                    if (connectedSection) connectedSection.classList.remove('hidden');
                    if (notConnectedSection) notConnectedSection.classList.add('hidden');
                    if (connectedEmailElement) connectedEmailElement.textContent = email || 'your Gmail account';
                    
                    console.log('UI updated to show Gmail as connected');
                } else {
                    // Update localStorage to persist connection state
                    localStorage.removeItem('gmailConnected');
                    localStorage.removeItem('gmailEmail');
                    
                    // Update UI elements if they exist
                    if (connectedSection) connectedSection.classList.add('hidden');
                    if (notConnectedSection) notConnectedSection.classList.remove('hidden');
                    
                    console.log('UI updated to show Gmail as not connected');
                }
            } catch (error) {
                console.error('Error updating Gmail connection status in UI:', error);
            }
        }
        
        // Enhanced Gmail connection status check with comprehensive error handling
        async function checkGmailConnection() {
            try {
                console.log('Checking Gmail connection status...');
                
                // Check for token in localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('No authentication token found, Gmail not connected');
                    updateGmailConnectionStatus(false);
                    return;
                }
                
                // Get environment information
                const baseUrl = getBaseUrl();
                const platform = hostname.includes('vercel.app') ? 'vercel' : 
                               hostname.includes('onrender.com') ? 'render' : 'other';
                
                console.log('Gmail status check - Environment details:');
                console.log('- BASE_URL:', baseUrl);
                console.log('- Hostname:', hostname);
                console.log('- Platform:', platform);
                
                // Check Gmail connection status
                let data = { connected: false };
                
                try {
                    const response = await fetch(`${baseUrl}/api/gmail/status?platform=${platform}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    // Check if we got HTML instead of JSON (common error when endpoint doesn't exist)
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('text/html')) {
                        console.error('Received HTML response instead of JSON. API endpoint may not exist.');
                        console.log('Content type:', contentType);
                        updateGmailConnectionStatus(false);
                        return;
                    }
                    
                    // Handle different response scenarios
                    if (response.status === 401 || response.status === 403) {
                        console.error('Authentication failed when checking Gmail status');
                        updateGmailConnectionStatus(false);
                        return;
                    } else if (!response.ok) {
                        console.error('Error checking Gmail status:', response.status, response.statusText);
                        updateGmailConnectionStatus(false);
                        return;
                    }
                    
                    // Try to parse JSON response, with error handling
                    const text = await response.text();
                    try {
                        data = JSON.parse(text);
                        console.log('Gmail connection status response:', data);
                    } catch (jsonError) {
                        console.error('Failed to parse JSON response:', jsonError);
                        console.log('Raw response:', text.substring(0, 100) + '...');
                        updateGmailConnectionStatus(false);
                        return;
                    }
                } catch (fetchError) {
                    console.error('Error fetching Gmail status:', fetchError);
                    updateGmailConnectionStatus(false);
                    return;
                }
                
                if (data && data.connected) {
                    console.log('Gmail is connected, updating status');
                    localStorage.setItem('gmailConnected', 'true');
                    
                    // Get user profile if connected
                    console.log('Fetching Gmail profile information...');
                    const profileResponse = await fetch(`${baseUrl}/api/gmail/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (profileResponse.ok) {
                        const profileData = await profileResponse.json();
                        console.log('Gmail profile data received:', profileData);
                        
                        // Store email in localStorage for future reference
                        if (profileData.user && profileData.user.email) {
                            localStorage.setItem('gmailEmail', profileData.user.email);
                        }
                        
                        // Update UI with connection status
                        updateGmailConnectionStatus(true, profileData.user?.email || 'Connected');
                        
                        // Show emails section if connected
                        const emailsSection = document.getElementById('emailsSection');
                        if (emailsSection) {
                            emailsSection.classList.remove('hidden');
                            loadUserEmails();
                        } else {
                            console.warn('Emails section element not found in DOM');
                        }
                    } else {
                        console.warn('Failed to fetch Gmail profile, but connection is active');
                        updateGmailConnectionStatus(true, localStorage.getItem('gmailEmail') || 'Connected');
                    }
                } else {
                    console.log('Gmail is not connected');
                    localStorage.removeItem('gmailConnected');
                    localStorage.removeItem('gmailEmail');
                    updateGmailConnectionStatus(false);
                }
            } catch (error) {
                console.error('Error in checkGmailStatus:', error);
                updateGmailConnectionStatus(false);
            }
        }
        
        // Function to load user emails with enhanced privacy
        async function loadUserEmails() {
            try {
                console.log('Loading user emails...');
                const emailsContainer = document.getElementById('emailsList');
                emailsContainer.innerHTML = '<div class="text-center p-4"><div class="spinner"></div><p class="mt-2 text-gray-400">Loading emails...</p></div>';
                
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found');
                }
                
                const baseUrl = getBaseUrl();
                console.log('Fetching emails from:', `${baseUrl}/api/gmail/fetch-emails`);
                const response = await fetch(`${baseUrl}/api/gmail/fetch-emails`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Email fetch response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    // Sanitize log data to remove sensitive information
                    const sanitizedData = {
                        ...data,
                        emails: data.emails ? data.emails.map(email => ({
                            ...email,
                            subject: 'REDACTED',
                            from: 'REDACTED',
                            body: 'REDACTED',
                            html: 'REDACTED',
                            textPlain: 'REDACTED'
                        })) : []
                    };
                    console.log('Emails data (sanitized):', sanitizedData);
                    emailsContainer.innerHTML = '';
                    
                    if (data.emails.length === 0) {
                        emailsContainer.innerHTML = '<div class="text-center text-gray-400 py-8">No emails analyzed yet</div>';
                        return;
                    }
                    
                    // Render emails
                    data.emails.forEach(email => {
                        const emailItem = document.createElement('div');
                        emailItem.className = 'border border-gray-700 rounded-lg p-4 hover:bg-white/5 transition mb-4';
                        
                        // Set background color based on risk level
                        let riskBgClass = 'bg-green-900/20';
                        let riskTextClass = 'text-green-400';
                        
                        if (email.phishingRisk === 'Medium') {
                            riskBgClass = 'bg-yellow-900/20';
                            riskTextClass = 'text-yellow-400';
                        } else if (email.phishingRisk === 'High') {
                            riskBgClass = 'bg-orange-900/20';
                            riskTextClass = 'text-orange-400';
                        } else if (email.phishingRisk === 'Critical') {
                            riskBgClass = 'bg-red-900/20';
                            riskTextClass = 'text-red-400';
                        }
                        
                        const date = new Date(email.date).toLocaleString();
                        
                        // Mask sender email for privacy
                        const maskedFrom = email.from.split('@').length > 1 ? 
                            `${email.from.split('@')[0].substring(0, 3)}***@${email.from.split('@')[1]}` : 
                            'Protected Email';
                        
                        // Don't show the actual subject, just indicate if it exists
                        const privacySubject = email.subject ? 'Email Subject (Protected)' : '(No Subject)';
                        
                        emailItem.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-white font-medium">${privacySubject}</h3>
                                    <p class="text-gray-400 text-sm">From: ${maskedFrom}</p>
                                    <p class="text-gray-400 text-sm">Date: ${date}</p>
                                </div>
                                <div class="${riskBgClass} px-3 py-1 rounded-full">
                                    <span class="${riskTextClass} text-sm font-medium">${email.phishingRisk} Risk</span>
                                </div>
                            </div>
                            <div class="mt-3 grid grid-cols-4 gap-2 text-center text-xs">
                                <div class="bg-gray-800 rounded p-2">
                                    <p class="text-gray-400">Header</p>
                                    <p class="text-white font-medium">${email.scores.header}</p>
                                </div>
                                <div class="bg-gray-800 rounded p-2">
                                    <p class="text-gray-400">Text</p>
                                    <p class="text-white font-medium">${email.scores.text}</p>
                                </div>
                                <div class="bg-gray-800 rounded p-2">
                                    <p class="text-gray-400">Metadata</p>
                                    <p class="text-white font-medium">${email.scores.metadata}</p>
                                </div>
                                <div class="bg-gray-800 rounded p-2">
                                    <p class="text-gray-400">Attachments</p>
                                    <p class="text-white font-medium">${email.scores.attachments}</p>
                                </div>
                            </div>
                            <div class="mt-3 text-right">
                                <span class="text-gray-400 text-sm">Total Score: <span class="text-white font-medium">${email.scores.total}</span></span>
                            </div>
                        `;
                        
                        emailsContainer.appendChild(emailItem);
                    });
                }
            } catch (error) {
                console.error('Error loading emails:', error);
            } finally {
                hideLoading();
            }
        }
        
        // Function to disconnect Gmail account
        async function disconnectGmail() {
            showLoading();
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found. Please log in again.');
                }
                
                // Call the API to disconnect Gmail
                const baseUrl = getBaseUrl();
                console.log('Disconnecting Gmail using endpoint:', `${baseUrl}/api/gmail/disconnect`);
                
                const response = await fetch(`${baseUrl}/api/gmail/disconnect`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                // Clear Gmail connection data from localStorage
                localStorage.removeItem('gmailConnected');
                localStorage.removeItem('gmailEmail');
                
                // Update UI to show Gmail as not connected
                updateGmailConnectionStatus(false);
                
                // Hide the emails section
                const emailsSection = document.getElementById('emailsSection');
                if (emailsSection) {
                    emailsSection.classList.add('hidden');
                }
                
                // Show success message
                showSuccessNotification('Gmail Disconnected', 'Your Gmail account has been successfully disconnected.');
                
                // Refresh the page to update all UI elements
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Gmail disconnect error:', error);
                hideLoading();
                showError('Disconnect Error', error.message);
            }
        }
        
        // Function to sync emails manually
        async function syncEmails() {
            showLoading();
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found. Please log in again.');
                }
                
                // Get user ID from localStorage or fetch from profile
                let userId = localStorage.getItem('userId');
                if (!userId) {
                    // Fetch user profile to get ID
                    const baseUrl = getBaseUrl();
                    const profileResponse = await fetch(`${baseUrl}/api/users/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!profileResponse.ok) {
                        throw new Error('Could not retrieve user profile');
                    }
                    
                    const profileData = await profileResponse.json();
                    userId = profileData.user._id;
                    localStorage.setItem('userId', userId);
                }
                
                // Call the API to sync emails
                const baseUrl = getBaseUrl();
                console.log('Syncing emails using endpoint:', `${baseUrl}/api/gmail/fetch-emails`);
                
                const response = await fetch(`${baseUrl}/api/gmail/fetch-emails`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                hideLoading();
                
                // Show success message and refresh emails list
                showSuccessNotification('Emails Synced', 'Your emails have been successfully synced.');
                loadUserEmails();
                
                return data;
            } catch (error) {
                console.error('Email sync error:', error);
                hideLoading();
                showError('Email Sync Error', error.message);
                return null;
            }
        }
        
        // Function to show phishing analysis modal with email details
        function showPhishingAnalysisModal(email) {
            // Get the modal and content elements
            const modal = document.getElementById('phishingAnalysisModal');
            const content = document.getElementById('phishingAnalysisContent');
            
            // Clear previous content
            content.innerHTML = '';
            
            // Format the risk level with appropriate color
            let riskClass = 'risk-low';
            if (email.phishingRisk === 'High') {
                riskClass = 'risk-high';
            } else if (email.phishingRisk === 'Medium') {
                riskClass = 'risk-medium';
            }
            
            // Create the email header section
            const headerSection = document.createElement('div');
            headerSection.className = 'bg-gray-800/50 rounded-lg p-4 mb-4';
            headerSection.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <div class="${email.phishingRisk === 'High' ? 'bg-red-500/20' : email.phishingRisk === 'Medium' ? 'bg-yellow-500/20' : 'bg-green-500/20'} p-2 rounded-full mr-3">
                            <i class="fas ${email.phishingRisk === 'High' ? 'fa-exclamation-triangle text-red-500' : email.phishingRisk === 'Medium' ? 'fa-exclamation-circle text-yellow-500' : 'fa-check-circle text-green-500'}"></i>
                        </div>
                        <div>
                            <h3 class="text-white font-semibold">${email.subject || 'No Subject'}</h3>
                            <p class="text-gray-400 text-sm">From: ${email.from}</p>
                        </div>
                    </div>
                    <div class="risk-badge ${riskClass}">
                        <i class="fas fa-shield-alt mr-1"></i> ${email.scores.total}/100 Risk
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill-${email.phishingRisk === 'High' ? 'high' : email.phishingRisk === 'Medium' ? 'medium' : 'low'}" style="width: ${email.scores.total}%"></div>
                </div>
            `;
            content.appendChild(headerSection);
            
            // Create the scores breakdown section
            const scoresSection = document.createElement('div');
            scoresSection.className = 'bg-gray-800/50 rounded-lg p-4 mb-4';
            scoresSection.innerHTML = `
                <h3 class="text-white font-semibold mb-3">Risk Score Breakdown</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Header Analysis</p>
                        <div class="progress-bar">
                            <div class="progress-fill-${email.scores.header > 30 ? 'high' : email.scores.header > 15 ? 'medium' : 'low'}" style="width: ${email.scores.header}%"></div>
                        </div>
                        <p class="text-right text-xs text-gray-400 mt-1">${email.scores.header}/50</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Content Analysis</p>
                        <div class="progress-bar">
                            <div class="progress-fill-${email.scores.text > 30 ? 'high' : email.scores.text > 15 ? 'medium' : 'low'}" style="width: ${email.scores.text}%"></div>
                        </div>
                        <p class="text-right text-xs text-gray-400 mt-1">${email.scores.text}/50</p>
                    </div>
                </div>
            `;
            content.appendChild(scoresSection);
            
            // Create URLs section if there are any
            if (email.urls && email.urls.length > 0) {
                const urlsSection = document.createElement('div');
                urlsSection.className = 'bg-gray-800/50 rounded-lg p-4 mb-4';
                urlsSection.innerHTML = `
                    <h3 class="text-white font-semibold mb-3">Detected URLs</h3>
                    <div class="space-y-2 max-h-40 overflow-y-auto">
                        ${email.urls.map(url => `
                            <div class="bg-gray-700/50 p-2 rounded text-sm">
                                <span class="text-gray-300 break-all">${url.url}</span>
                                ${url.suspicious ? '<span class="ml-2 bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded">Suspicious</span>' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                content.appendChild(urlsSection);
            }
            
            // Create email body preview section
            const bodySection = document.createElement('div');
            bodySection.className = 'bg-gray-800/50 rounded-lg p-4';
            bodySection.innerHTML = `
                <h3 class="text-white font-semibold mb-3">Email Content Preview</h3>
                <div class="bg-gray-700/50 p-3 rounded text-sm text-gray-300 max-h-60 overflow-y-auto whitespace-pre-wrap">${email.body || 'No content available'}</div>
            `;
            content.appendChild(bodySection);
            
            // Show the modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Add event listeners to close buttons
            document.getElementById('closePhishingModal').addEventListener('click', hidePhishingAnalysisModal);
            document.getElementById('closePhishingModalBtn').addEventListener('click', hidePhishingAnalysisModal);
        }

        // Function to hide phishing analysis modal
        function hidePhishingAnalysisModal() {
            const modal = document.getElementById('phishingAnalysisModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Function to scan emails
        async function scanEmails() {
            showLoading();
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found. Please log in again.');
                }
                
                // Call the API to scan emails
                const baseUrl = getBaseUrl();
                console.log('Scanning emails using endpoint:', `${baseUrl}/api/gmail/scan`);
                
                const response = await fetch(`${baseUrl}/api/gmail/scan`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    // Add empty body to ensure proper POST request
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    // If we have scanned emails with results, show the first one in the modal
                    if (data.emails && data.emails.length > 0) {
                        showPhishingAnalysisModal(data.emails[0]);
                        
                        // Also refresh the emails list to show all scanned emails
                        loadUserEmails();
                    } else {
                        // If no emails were found or processed
                        showSuccessNotification('Scan Complete', 'No new emails were found to scan.');
                    }
                } else {
                    throw new Error(data.message || 'Failed to scan emails');
                }
            } catch (error) {
                console.error('Email scan error:', error);
                hideLoading();
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showError('Network Error', 'Cannot connect to the server. Please check your internet connection.');
                } else {
                    showError('Email Scan Error', error.message);
                }
            }
        }
        
        // Enhanced Gmail connection function with comprehensive error handling and platform detection
        async function connectGmail() {
            hideGmailAuthModal();
            showLoading();
            
            try {
                // Get auth token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found. Please log in again.');
                }
                
                // Store the exact current URL to return after auth
                const currentUrl = window.location.href;
                localStorage.setItem('gmailAuthReturnUrl', currentUrl);
                
                // Get environment information for debugging
                const baseUrl = getBaseUrl();
                const hostname = window.location.hostname;
                const origin = window.location.origin;
                
                console.log('Gmail connection - Environment details:');
                console.log('- BASE_URL:', baseUrl);
                console.log('- Hostname:', hostname);
                console.log('- Origin:', origin);
                console.log('- Return URL:', currentUrl);
                
                // Determine platform for server-side handling
                const platform = hostname.includes('vercel.app') ? 'vercel' : 
                               hostname.includes('onrender.com') ? 'render' : 'other';
                
                // Determine the correct redirect URI based on environment
                let redirectUri;
                
                if (platform === 'vercel') {
                    redirectUri = 'https://chd-police-hackathon.vercel.app/api/gmail/callback';
                } else if (platform === 'render') {
                    redirectUri = 'https://email-detection-api.onrender.com/api/gmail/callback';
                } else {
                    // For local development or unknown environments
                    redirectUri = window.location.origin + window.location.pathname;
                    console.log('Using default redirect URI:', redirectUri);
                }
                
                console.log('Using redirect URI:', redirectUri);
                console.log('Platform detected:', platform);
                
                // Get the OAuth URL from our backend with explicit redirect_uri and platform info
                const response = await fetch(`${baseUrl}/api/gmail/auth-url?platform=${platform}&redirect_uri=${encodeURIComponent(redirectUri)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Enhanced error handling with specific error messages
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Authentication failed. Please log in again.');
                } else if (response.status === 404) {
                    throw new Error('Gmail API endpoint not found. The server might be misconfigured.');
                } else if (response.status === 400) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Invalid request: ${errorData.message || 'Bad request parameters'}`);
                } else if (response.status === 500) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Server error: ${errorData.message || 'Internal server error'}`);
                } else if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Error ${response.status}: ${errorData.message || response.statusText || 'Unknown error'}`);
                }
                
                const data = await response.json();
                
                if (!data.authUrl) {
                    throw new Error('Invalid response from server: Missing authentication URL');
                }
                
                console.log('Redirecting to Google OAuth consent screen');
                
                // Redirect to Google OAuth consent screen
                window.location.href = data.authUrl;
                
            } catch (error) {
                hideLoading();
                console.error('Gmail connection error:', error);
                
                // Provide helpful error messages based on error type
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showError('Network Error', 'Cannot connect to the server. Please check your internet connection and try again.');
                } else if (error.message.includes('Authentication failed')) {
                    showError('Authentication Error', 'Your login session has expired. Please log in again.');
                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 3000);
                } else {
                    showError('Gmail Connection Error', error.message);
                }
            }
        }
        
        // Enhanced function to disconnect Gmail with better error handling
        async function disconnectGmail() {
            showLoading();
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found. Please log in again.');
                }
                
                // Call the disconnect endpoint
                const response = await fetch(`${BASE_URL}/api/gmail/disconnect`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Handle HTTP errors
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Authentication failed. Please log in again.');
                } else if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Server error: ${errorData.message || response.statusText || 'Unknown error'}`);
                }
                
                // Update UI
                updateGmailConnectionStatus(false);
                
                // Remove Gmail connection from localStorage
                localStorage.removeItem('gmailConnected');
                localStorage.removeItem('gmailEmail');
                
                hideLoading();
                showSuccessNotification('Gmail Disconnected', 'Your Gmail account has been successfully disconnected.');
            } catch (error) {
                console.error('Gmail disconnection error:', error);
                hideLoading();
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showError('Network Error', 'Cannot connect to the server. Please check your internet connection and try again.');
                } else {
                    showError('Gmail Disconnection Error', error.message);
                }
            }
        }
        
        // Fix 4: Enhanced function to handle OAuth callback with better logging
        function handleGmailOAuthCallback() {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            console.log('Detected OAuth callback. Code exists:', !!code, 'Error exists:', !!error);
            
            if (error) {
                // Handle OAuth error
                console.error('OAuth error from Google:', error);
                showError('Gmail Authorization Failed', `Error: ${error}`);
                return;
            }
            
            if (code) {
                console.log('Authorization code received, exchanging for tokens...');
                // Exchange the code for tokens
                exchangeCodeForTokens(code);
            }
        }
        
        // Enhanced function to exchange authorization code for tokens with comprehensive error handling
        async function exchangeCodeForTokens(code) {
            showLoading();
            
            try {
                // Get auth token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found. Please log in again.');
                }
                
                // Store the exact current URL to return after auth
                const currentUrl = window.location.href;
                localStorage.setItem('gmailAuthReturnUrl', currentUrl);
                
                // Get environment information for debugging
                const baseUrl = getBaseUrl();
                const hostname = window.location.hostname;
                const origin = window.location.origin;
                
                console.log('Exchange code using BASE_URL:', baseUrl);
                console.log('Current hostname:', hostname);
                console.log('Current origin:', origin);
                console.log('Current pathname:', window.location.pathname);
                
                // Determine the correct redirect URI based on environment
                let redirectUri;
                hostname = window.location.hostname;
                
                if (hostname.includes('vercel.app')) {
                    redirectUri = window.location.origin + '/admin.html';
                    console.log('Using Vercel redirect URI:', redirectUri);
                } else if (hostname.includes('onrender.com')) {
                    redirectUri = 'https://email-detection-api.onrender.com/admin.html';
                    console.log('Using Render redirect URI:', redirectUri);
                } else {
                    // For local development or unknown environments
                    redirectUri = window.location.origin + window.location.pathname;
                    console.log('Using default redirect URI:', redirectUri);
                }
                
                console.log('Using redirect URI:', redirectUri);
                console.log('Platform detected:', hostname.includes('vercel.app') ? 'vercel' : 
                           hostname.includes('onrender.com') ? 'render' : 'other');
                
                // Call backend to exchange code for tokens with explicit platform information
                const response = await fetch(`${baseUrl}/api/gmail/oauth-callback`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        code,
                        redirectUri,
                        platform: hostname.includes('vercel.app') ? 'vercel' : 
                                 hostname.includes('onrender.com') ? 'render' : 'other'
                    })
                });
                
                // Enhanced error handling with specific error messages
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Authentication failed. Please log in again.');
                } else if (response.status === 400) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Invalid request: ${errorData.message || 'Bad request parameters'}`);
                } else if (response.status === 404) {
                    throw new Error('API endpoint not found. The server might be misconfigured.');
                } else if (response.status === 500) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Server error: ${errorData.message || 'Internal server error'}`);
                } else if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Error ${response.status}: ${errorData.message || response.statusText || 'Unknown error'}`);
                }
                
                const data = await response.json();
                console.log('OAuth callback response:', data);
                console.log('OAuth callback status:', data.success ? 'Success' : 'Failed');
                
                if (data.success) {
                    // Store Gmail connection status
                    localStorage.setItem('gmailConnected', 'true');
                    
                    // Get user email if available
                    if (data.email) {
                        localStorage.setItem('gmailEmail', data.email);
                    }
                    
                    // Update UI
                    updateGmailConnectionStatus(true, data.email || localStorage.getItem('userEmail'));
                    
                    // Show success message
                    showSuccessNotification('Gmail Connected Successfully', 'Your Gmail account is now connected and protected.');
                    
                    // If we have a return URL, redirect back
                    const returnUrl = localStorage.getItem('gmailAuthReturnUrl');
                    if (returnUrl) {
                        localStorage.removeItem('gmailAuthReturnUrl');
                        window.location.href = returnUrl;
                    }
                } else {
                    throw new Error(data.message || 'Failed to connect Gmail account');
                }
            } catch (error) {
                console.error('Error exchanging code for tokens:', error);
                showError('Gmail Connection Error', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Function to check Gmail connection status from the server
        async function checkGmailStatus() {
            try {
                console.log('Checking Gmail connection status...');
                
                // Check if we just completed OAuth flow (URL has connected=true)
                const urlParams = new URLSearchParams(window.location.search);
                const justConnected = urlParams.get('connected') === 'true';
                
                if (justConnected) {
                    console.log('Detected successful OAuth completion from URL parameter');
                    // Remove the query parameter to avoid confusion on page refresh
                    const newUrl = window.location.pathname + window.location.hash;
                    window.history.replaceState({}, document.title, newUrl);
                    
                    // Force update the connection status
                    updateGmailConnectionStatus(true, 'Gmail Account');
                    
                    // Add null check before accessing classList
                    const emailsSection = document.getElementById('emailsSection');
                    if (emailsSection) {
                        emailsSection.classList.remove('hidden');
                        loadUserEmails();
                    } else {
                        console.warn('emailsSection element not found in DOM');
                    }
                    return;
                }
                
                const response = await fetch(`${BASE_URL}/api/users/gmail-status`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('Gmail status response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Gmail connection data:', data);
                    
                    if (data.gmailConnected) {
                        // Get user profile to get the email
                        const profileResponse = await fetch(`${BASE_URL}/api/users/profile`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });
                        
                        if (profileResponse.ok) {
                            const profileData = await profileResponse.json();
                            updateGmailConnectionStatus(true, profileData.user.email);
                            
                            // Show emails section if connected
                            const emailsSection = document.getElementById('emailsSection');
                            if (emailsSection) {
                                emailsSection.classList.remove('hidden');
                                loadUserEmails();
                            } else {
                                console.log('Emails section not found in DOM');
                            }
                        }
                    } else {
                        updateGmailConnectionStatus(false);
                    }
                } else {
                    // Handle error response
                    console.error('Error checking Gmail status:', response.status);
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Error details:', errorData);
                    
                    // If unauthorized, check if we need to reconnect
                    if (response.status === 401) {
                        updateGmailConnectionStatus(false);
                    }
                }
            } catch (error) {
                console.error('Error checking Gmail status:', error);
            }
        }
        
        // Update UI based on Gmail connection status
        function updateGmailConnectionStatus(isConnected, email = '') {
            const statusElement = document.getElementById('emailConnectionStatus');
            
            if (isConnected) {
                statusElement.classList.remove('bg-yellow-600/20', 'border-yellow-600/30');
                statusElement.classList.add('bg-green-600/20', 'border-green-600/30');
                
                statusElement.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <div class="bg-green-500/20 p-3 rounded-full">
                            <i class="fas fa-check-circle text-green-400 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-1">Gmail Account Connected</h3>
                            <p class="text-gray-300 mb-2">Your account <span class="text-blue-300 font-medium" id="connectedEmail">${email}</span> is now protected.</p>
                            <div class="flex space-x-3">
                                <button id="disconnectGmailBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-xs font-medium transition duration-150 ease-in-out flex items-center">
                                    <i class="fas fa-unlink mr-1"></i> Disconnect
                                </button>
                                <button id="scanNowBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-xs font-medium transition duration-150 ease-in-out flex items-center">
                                    <i class="fas fa-search mr-1"></i> Scan Now
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners to new buttons
                document.getElementById('disconnectGmailBtn').addEventListener('click', disconnectGmail);
                document.getElementById('scanNowBtn').addEventListener('click', scanEmails);
                
                // Update user email in header
                document.getElementById('userEmail').textContent = email;
            } else {
                // Reset to disconnected state (default HTML)
                statusElement.classList.remove('bg-green-600/20', 'border-green-600/30');
                statusElement.classList.add('bg-yellow-600/20', 'border-yellow-600/30');
                
                statusElement.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <div class="bg-yellow-500/20 p-3 rounded-full">
                            <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-1">Email Account Not Connected</h3>
                            <p class="text-gray-300 mb-4">Connect your Gmail account to enable email phishing protection.</p>
                            <button id="connectGmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center">
                                <i class="fab fa-google mr-2"></i> Connect Gmail Account
                            </button>
                        </div>
                    </div>
                `;
                
                // Re-add event listener to connect button
                document.getElementById('connectGmailBtn').addEventListener('click', showGmailAuthModal);
            }
        }
        
        // Function to check Gmail connection status from the server
        async function checkGmailStatus() {
            try {
                console.log('Checking Gmail connection status...');
                
                // Check if we just completed OAuth flow (URL has connected=true)
                const urlParams = new URLSearchParams(window.location.search);
                const justConnected = urlParams.get('connected') === 'true';
                
                if (justConnected) {
                    console.log('Detected successful OAuth completion from URL parameter');
                    // Remove the query parameter to avoid confusion on page refresh
                    const newUrl = window.location.pathname + window.location.hash;
                    window.history.replaceState({}, document.title, newUrl);
                    
                    // Force update the connection status
                    updateGmailConnectionStatus(true, 'Gmail Account');
                    
                    // Add null check before accessing classList
                    const emailsSection = document.getElementById('emailsSection');
                    if (emailsSection) {
                        emailsSection.classList.remove('hidden');
                        loadUserEmails();
                    } else {
                        console.warn('emailsSection element not found in DOM');
                    }
                    return;
                }
                
                const response = await fetch(`${BASE_URL}/api/users/gmail-status`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('Gmail status response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Gmail connection data:', data);
                    
                    if (data.gmailConnected) {
                        // Get user profile to get the email
                        const profileResponse = await fetch(`${BASE_URL}/api/users/profile`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });
                        
                        if (profileResponse.ok) {
                            const profileData = await profileResponse.json();
                            updateGmailConnectionStatus(true, profileData.user.email);
                            
                            // Show emails section if connected
                            const emailsSection = document.getElementById('emailsSection');
                            if (emailsSection) {
                                emailsSection.classList.remove('hidden');
                                loadUserEmails();
                            } else {
                                console.log('Emails section not found in DOM');
                            }
                        }
                    } else {
                        updateGmailConnectionStatus(false);
                    }
                } else {
                    // Handle error response
                    console.error('Error checking Gmail status:', response.status);
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Error details:', errorData);
                    
                    // If unauthorized, check if we need to reconnect
                    if (response.status === 401) {
                        updateGmailConnectionStatus(false);
                    }
                }
            } catch (error) {
                console.error('Error checking Gmail status:', error);
            }
        }
        
        // Check if user is authenticated - Updated for consistent behavior across deployments
        async function checkAuth() {
            try {
                // Get the dynamic base URL
                const baseUrl = getBaseUrl();
                console.log('Checking auth with BASE_URL:', baseUrl);
                console.log('Current hostname:', window.location.hostname);
                
                // First check the userRole
                const userRole = localStorage.getItem('userRole');
                const token = localStorage.getItem('token');
                
                console.log('Checking auth status - Role:', userRole, 'Token exists:', !!token);
                
                // If we don't have a token, redirect to login
                if (!token) {
                    console.log('No token found, redirecting to login');
                    window.location.href = `${baseUrl}/login.html`;
                    return;
                }
                
                // If we have a token, verify it with the server
                try {
                    const response = await fetch(`${baseUrl}/auth/check-auth`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    // If the token is invalid, redirect to login
                    if (!response.ok) {
                        console.error('Token verification failed:', response.status);
                        localStorage.removeItem('token');
                        localStorage.removeItem('userRole');
                        window.location.href = `${baseUrl}/login.html`;
                        return;
                    }
                    
                    // Token is valid, get user data
                    const data = await response.json();
                    console.log('Auth verification successful:', data);
                    
                    // Update user email in the UI
                    if (data.user && data.user.email) {
                        console.log('Setting user email in UI:', data.user.email);
                        const userEmailElement = document.getElementById('userEmail');
                        if (userEmailElement) {
                            userEmailElement.textContent = data.user.email;
                            localStorage.setItem('userEmail', data.user.email);
                        } else {
                            console.warn('userEmail element not found in DOM');
                        }
                    } else {
                        console.warn('User data missing email property:', data);
                    }
                    
                    return;
                } catch (error) {
                    console.error('Error verifying token:', error);
                    
                    // If there was a network error, don't redirect - might be offline
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        console.warn('Network error during auth check, using cached credentials');
                        
                        // Use cached credentials if available
                        if (token && userRole) {
                            console.log('Using cached credentials - Role:', userRole);
                            return;
                        }
                    }
                    
                    // For other errors, redirect to login
                    localStorage.removeItem('token');
                    localStorage.removeItem('userRole');
                    window.location.href = `${baseUrl}/login.html`;
                    return;
                }
                
                // This code will only run if all authentication methods fail
                console.log('Not authenticated, redirecting to login');
                window.location.href = `${baseUrl}/login.html`;
            } catch (error) {
                console.error('Auth check error:', error);
                // Don't redirect immediately on error
                // The server might be temporarily unavailable
            }
        }

        // Initialize the page after DOM is fully loaded
        async function initializePage() {
            console.log('Initializing page...');
            
            try {
                // Check if this is an OAuth callback
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('code') || urlParams.has('error')) {
                    console.log('Detected OAuth callback parameters in URL');
                    await handleGmailOAuthCallback();
                    return; // Don't proceed with normal initialization during OAuth callback
                }
                
                // Check if user is authenticated first
                await checkAuth();
                
                // Check Gmail connection status from localStorage for faster UI update
                const gmailConnected = localStorage.getItem('gmailConnected') === 'true';
                const gmailEmail = localStorage.getItem('gmailEmail');
                
                console.log('Gmail connection from localStorage:', gmailConnected ? 'Connected' : 'Not connected');
                if (gmailConnected) {
                    updateGmailConnectionStatus(true, gmailEmail || localStorage.getItem('userEmail'));
                    
                    // Show emails section if it exists
                    const emailsSection = document.getElementById('emailsSection');
                    if (emailsSection) {
                        emailsSection.classList.remove('hidden');
                    }
                }
                
                // Add event listeners for Gmail connection buttons
                const connectBtn = document.getElementById('connectGmailBtn');
                if (connectBtn) {
                    connectBtn.addEventListener('click', showGmailAuthModal);
                }
                
                // Modal event listeners
                document.getElementById('closeModal')?.addEventListener('click', hideGmailAuthModal);
                document.getElementById('authorizeGmailBtn')?.addEventListener('click', connectGmail);
                document.getElementById('cancelGmailAuthBtn')?.addEventListener('click', hideGmailAuthModal);
                
                // Check Gmail connection status from server
                await checkGmailConnection();
                
                // Set up error handling for fetch operations
                window.addEventListener('unhandledrejection', function(event) {
                    console.error('Unhandled promise rejection:', event.reason);
                    if (event.reason.message && event.reason.message.includes('Failed to fetch')) {
                        showError('Connection Error', 'Cannot connect to the server. Please check your internet connection.');
                    }
                });
                
                console.log('Application initialization complete');
            } catch (error) {
                console.error('Error during application initialization:', error);
                showError('Initialization Error', 'Something went wrong while loading the application. Please refresh the page.');
            }
        }

        // Handle OAuth callback from Google
        async function handleGmailOAuthCallback() {
            // Check if we have a code parameter in the URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                console.error('OAuth error:', error);
                showError('Gmail Connection Error', 'Authorization was denied or an error occurred during the OAuth process.');
                return false;
            }
            
            if (code) {
                console.log('OAuth code detected in URL, processing callback...');
                showLoading();
                
                try {
                    // Exchange the code for tokens
                    await exchangeCodeForTokens(code);
                    return true;
                } catch (error) {
                    console.error('Error handling OAuth callback:', error);
                    showError('Gmail Connection Error', 'Failed to complete the OAuth process. ' + error.message);
                    return false;
                } finally {
                    hideLoading();
                }
            }
            
            return false;
        }
        
        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            
            // Add event listeners for Gmail connection buttons
            const scanNowBtn = document.getElementById('scanNowBtn');
            if (scanNowBtn) {
                scanNowBtn.addEventListener('click', scanEmails);
            }
            
            const syncEmailsBtn = document.getElementById('syncEmailsBtn');
            if (syncEmailsBtn) {
                syncEmailsBtn.addEventListener('click', syncEmails);
            }
            
            const disconnectGmailBtn = document.getElementById('disconnectGmailBtn');
            if (disconnectGmailBtn) {
                disconnectGmailBtn.addEventListener('click', disconnectGmail);
            }
        });

        // Handle logout with improved reliability and visual feedback
        document.getElementById('logoutBtn').addEventListener('click', function() {
            // Show loading immediately when button is clicked
            showLoading();
            console.log('Logout initiated, showing loading indicator');
            
            // Use setTimeout to ensure the loading indicator has time to appear
            setTimeout(async function() {
                try {
                    // Use getBaseUrl() instead of BASE_URL to ensure we have the latest URL
                    const baseUrl = getBaseUrl();
                    console.log('Logging out from:', baseUrl);
                    console.log('Current hostname:', window.location.hostname);
                    
                    // Always clear local storage first to ensure logout works even if server call fails
                    console.log('Clearing local storage...');
                    localStorage.removeItem('token');
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('gmailConnected');
                    
                    // Clear any cookies by setting them to expire
                    document.cookie.split(';').forEach(cookie => {
                        const [name] = cookie.trim().split('=');
                        document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/;`;
                    });
                    
                    // Try to call the server logout endpoint, but don't wait for it
                    try {
                        console.log('Attempting server logout call...');
                        fetch(`${baseUrl}/api/auth/logout`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }).catch(err => {
                            console.log('Server logout call failed, but continuing with client-side logout');
                        });
                    } catch (serverError) {
                        console.log('Error calling server logout endpoint, but continuing with client-side logout');
                    }
                    
                    // Wait a moment to ensure loading indicator is visible
                    console.log('Preparing to redirect to login page...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Redirect to login page
                    const loginUrl = `${baseUrl}/login.html`;
                    console.log('Redirecting to:', loginUrl);
                    window.location.href = loginUrl;
                    
                    // If redirect doesn't work after a delay, try a more forceful approach
                    setTimeout(() => {
                        console.log('Forcing page reload as backup...');
                        window.location.replace(loginUrl);
                    }, 500);
                    
                } catch (error) {
                    console.error('Logout process error:', error);
                    // Even if there's an error, try to logout anyway
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Redirect to login page with a forced reload
                    const baseUrl = getBaseUrl();
                    const loginUrl = `${baseUrl}/login.html`;
                    console.log('Error during logout, forcing redirect to:', loginUrl);
                    window.location.replace(loginUrl);
                }
            }, 200); // Small delay to ensure loading indicator appears
        });

        // Check authentication when page loads
        checkAuth();
        
        // Check Gmail connection status when page loads
        checkGmailStatus();
        
        // Initialize the page after DOM is fully loaded
        async function initializePage() {
            console.log('Initializing admin page...');
            
            // Check if user is logged in
            if (!localStorage.getItem('token')) {
                console.log('No token found, redirecting to login');
                window.location.href = '/login.html';
                return;
            }
            
            // Check for Gmail connection in localStorage first (for faster UI update)
            if (localStorage.getItem('gmailConnected') === 'true') {
                console.log('Gmail connected according to localStorage');
                const email = localStorage.getItem('gmailEmail') || 'your Gmail account';
                updateGmailConnectionStatus(true, email);
                
                // Show emails section
                const emailsSection = document.getElementById('emailsSection');
                if (emailsSection) {
                    emailsSection.classList.remove('hidden');
                }
            }
            
            // Check Gmail connection status from server
            await checkGmailStatus();
            
            // Check URL parameters for connection status
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('connected') === 'true') {
                console.log('Connected parameter found in URL, refreshing emails');
                // Clean up URL
                const newUrl = window.location.pathname + window.location.hash;
                window.history.replaceState({}, document.title, newUrl);
                
                // Force load emails
                loadUserEmails();
            }
        }
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
    
    <!-- Phishing Analysis Modal -->
    <div id="phishingAnalysisModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-gray-900 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-white">Email Phishing Analysis</h2>
                <button id="closePhishingModal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="phishingAnalysisContent" class="p-4 overflow-y-auto flex-grow space-y-4">
                <!-- Content will be dynamically populated -->
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-end">
                <button id="closePhishingModalBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add CSS for the phishing analysis modal -->
    <style>
        .risk-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .risk-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: rgb(239, 68, 68);
        }
        
        .risk-medium {
            background-color: rgba(245, 158, 11, 0.2);
            color: rgb(245, 158, 11);
        }
        
        .risk-low {
            background-color: rgba(34, 197, 94, 0.2);
            color: rgb(34, 197, 94);
        }
        
        .progress-bar {
            background-color: rgba(55, 65, 81, 0.5);
            border-radius: 0.25rem;
            height: 0.5rem;
            overflow: hidden;
        }
        
        .progress-fill-high {
            background-color: rgb(239, 68, 68);
            height: 100%;
        }
        
        .progress-fill-medium {
            background-color: rgb(245, 158, 11);
            height: 100%;
        }
        
        .progress-fill-low {
            background-color: rgb(34, 197, 94);
            height: 100%;
        }
    </style>
</body>
</html>
