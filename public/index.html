<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .risk-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .risk-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: rgb(239, 68, 68);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .risk-medium {
            background-color: rgba(245, 158, 11, 0.2);
            color: rgb(245, 158, 11);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .risk-low {
            background-color: rgba(16, 185, 129, 0.2);
            color: rgb(16, 185, 129);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .progress-fill-high {
            background-color: rgb(239, 68, 68);
        }
        .progress-fill-medium {
            background-color: rgb(245, 158, 11);
        }
        .progress-fill-low {
            background-color: rgb(16, 185, 129);
        }
        .tab-active {
            border-bottom: 2px solid rgb(59, 130, 246);
            color: rgb(59, 130, 246);
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .analysis-layer {
            display: none;
        }
        .analysis-layer.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900">
    <!-- Background overlay with subtle pattern -->
    <div class="fixed inset-0 z-0 opacity-20" style="background-image: url('https://images.unsplash.com/photo-1544197150-b99a580bb7a8?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'); background-size: cover;"></div>
    <!-- Blue overlay for depth -->
    <div class="fixed inset-0 z-0 bg-blue-900 opacity-10"></div>
    
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white/10 backdrop-blur-lg p-6 rounded-lg flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-white">Processing your request...</p>
        </div>
    </div>
    
    <!-- Gmail Authorization Modal -->
    <div id="gmailAuthModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden">
            <div class="border-b border-gray-700 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-medium text-white">Connect Gmail Account</h3>
                <button id="closeModal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="text-gray-300 text-sm">
                    <p class="mb-4">By connecting your Gmail account, you authorize our application to:</p>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>Scan your emails for potential phishing threats</li>
                        <li>Analyze email headers and content for security risks</li>
                        <li>Detect suspicious links and attachments</li>
                        <li>Provide real-time alerts about dangerous emails</li>
                    </ul>
                    <p class="mt-4 text-blue-300"><i class="fas fa-lock mr-2"></i>We value your privacy and will never share your data with third parties.</p>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="authorizeGmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center">
                        <i class="fab fa-google mr-2"></i> Connect Gmail Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Container -->
    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- Top Navigation -->
        <nav class="bg-white/10 backdrop-blur-lg rounded-lg p-4 mb-8 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-blue-600 p-2 rounded-lg shadow-lg">
                    <i class="fas fa-shield-alt text-white"></i>
                </div>
                <span class="text-white font-bold">CHD Police Email Security</span>
            </div>
            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-1 text-gray-300 text-sm">
                    <i class="fas fa-user-circle text-blue-400"></i>
                    <span id="userEmail">user@example.com</span>
                </div>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Email Connection Status -->
        <div id="emailConnectionStatus" class="bg-yellow-600/20 backdrop-blur-lg rounded-lg p-6 mb-8 border border-yellow-600/30">
            <div class="flex items-start space-x-4">
                <div class="bg-yellow-500/20 p-3 rounded-full">
                    <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-1">Email Account Not Connected</h3>
                    <p class="text-gray-300 mb-4">Connect your Gmail account to enable email phishing protection.</p>
                    <button id="connectGmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center">
                        <i class="fab fa-google mr-2"></i> Connect Gmail Account
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Email Analysis Dashboard (Hidden until email is connected) -->
        <div id="emailAnalysisDashboard" class="hidden">
            <!-- Email Selection and Summary -->
            <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-white">Email Analysis</h2>
                        <p class="text-gray-400 text-sm">Detailed breakdown of potential threats</p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <select id="emailSelector" class="bg-gray-800 text-white border border-gray-700 rounded-md px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="email1">Suspicious PayPal Email (May 17, 2025)</option>
                            <option value="email2">Account Verification (May 16, 2025)</option>
                            <option value="email3">Your Invoice #INV-2025-0517 (May 15, 2025)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Overall Risk Score -->
                <div class="bg-gray-800/50 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <div class="bg-red-500/20 p-2 rounded-full mr-3">
                                <i class="fas fa-exclamation-triangle text-red-500"></i>
                            </div>
                            <div>
                                <h3 class="text-white font-semibold">High Risk Email Detected</h3>
                                <p class="text-gray-400 text-sm">From: "PayPal Service" &lt;service.paypal@suspicious-domain.com&gt;</p>
                            </div>
                        </div>
                        <div class="risk-badge risk-high">
                            <i class="fas fa-shield-alt mr-1"></i> 80/100 Risk
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill-high" style="width: 80%"></div>
                    </div>
                </div>
                
                <!-- Analysis Tabs -->
                <div class="border-b border-gray-700 mb-6">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                        <li class="mr-2">
                            <button class="tab-button tab-active inline-block p-4 text-blue-500 rounded-t-lg border-b-2 border-blue-500" data-target="headerAnalysis">Header Analysis</button>
                        </li>
                        <li class="mr-2">
                            <button class="tab-button inline-block p-4 text-gray-400 hover:text-gray-300 rounded-t-lg" data-target="contentAnalysis">Content Analysis</button>
                        </li>
                        <li class="mr-2">
                            <button class="tab-button inline-block p-4 text-gray-400 hover:text-gray-300 rounded-t-lg" data-target="metadataAnalysis">Metadata</button>
                        </li>
                        <li>
                            <button class="tab-button inline-block p-4 text-gray-400 hover:text-gray-300 rounded-t-lg" data-target="attachmentAnalysis">Attachments & URLs</button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Analysis Layers -->
            <div class="analysis-layers mb-8">
                <!-- Header Analysis Layer -->
                <div id="headerAnalysis" class="analysis-layer active">
                    <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-white">Header Analysis</h3>
                            <div class="risk-badge risk-high">
                                <i class="fas fa-shield-alt mr-1"></i> 22/25 Risk
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Left Column -->
                            <div class="space-y-4">
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">SPF Check</h4>
                                            <p class="text-gray-400 text-sm">Sender Policy Framework verification</p>
                                        </div>
                                        <span class="bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded font-medium">Fail</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">DKIM Validation</h4>
                                            <p class="text-gray-400 text-sm">DomainKeys Identified Mail signature</p>
                                        </div>
                                        <span class="bg-green-500/20 text-green-500 text-xs px-2 py-1 rounded font-medium">Pass</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">DMARC Policy</h4>
                                            <p class="text-gray-400 text-sm">Domain-based Message Authentication</p>
                                        </div>
                                        <span class="bg-yellow-500/20 text-yellow-500 text-xs px-2 py-1 rounded font-medium">Not Found</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">From vs Reply-To</h4>
                                            <p class="text-gray-400 text-sm">Check for mismatched email addresses</p>
                                        </div>
                                        <span class="bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded font-medium">Mismatch</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="space-y-4">
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">Sender IP Geolocation</h4>
                                            <p class="text-gray-400 text-sm">Origin of the email server</p>
                                        </div>
                                        <span class="bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded font-medium">Nigeria (ðŸ‡³ðŸ‡¬)</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-white font-medium">IP Reputation</h4>
                                            <p class="text-gray-400 text-sm">Blacklist status of sender IP</p>
                                        </div>
                                        <span class="bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded font-medium">Flagged by 2/3 RBLs</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4 h-full flex flex-col">
                                    <h4 class="text-white font-medium mb-2">Recommended Actions</h4>
                                    <div class="flex flex-col space-y-2 mt-auto">
                                        <button class="bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-2 rounded-md transition duration-150 ease-in-out flex items-center justify-center">
                                            <i class="fas fa-trash-alt mr-2"></i> Delete Email
                                        </button>
                                        <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-md transition duration-150 ease-in-out flex items-center justify-center">
                                            <i class="fas fa-file-code mr-2"></i> View Raw Headers
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // Use relative URLs for API calls to work with current domain
        // Using production environment only
        const BASE_URL = 'https://email-detection-api.onrender.com';
        
        // Show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
        }
        
        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('flex');
        }
        
        // Improved error handling and user feedback
        function showError(message, details = null) {
            // Create or update error notification element
            let errorNotification = document.getElementById('errorNotification');
            
            if (!errorNotification) {
                errorNotification = document.createElement('div');
                errorNotification.id = 'errorNotification';
                errorNotification.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-3 rounded shadow-lg z-50 flex items-start';
                document.body.appendChild(errorNotification);
            }
            
            errorNotification.innerHTML = `
                <div class="mr-3">
                    <i class="fas fa-exclamation-circle text-xl"></i>
                </div>
                <div>
                    <h4 class="font-bold">${message}</h4>
                    ${details ? `<p class="text-sm">${details}</p>` : ''}
                    <button class="text-xs underline mt-1" onclick="document.getElementById('errorNotification').remove()">Dismiss</button>
                </div>
            `;
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                if (document.getElementById('errorNotification')) {
                    document.getElementById('errorNotification').remove();
                }
            }, 8000);
            
            // Also log to console for debugging
            console.error(message, details);
        }
        
        // Success notification function
        function showSuccessNotification(title, message) {
            let successNotification = document.getElementById('successNotification');
            
            if (!successNotification) {
                successNotification = document.createElement('div');
                successNotification.id = 'successNotification';
                successNotification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-3 rounded shadow-lg z-50 flex items-start';
                document.body.appendChild(successNotification);
            }
            
            successNotification.innerHTML = `
                <div class="mr-3">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div>
                    <h4 class="font-bold">${title}</h4>
                    <p class="text-sm">${message}</p>
                    <button class="text-xs underline mt-1" onclick="document.getElementById('successNotification').remove()">Dismiss</button>
                </div>
            `;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (document.getElementById('successNotification')) {
                    document.getElementById('successNotification').remove();
                }
            }, 5000);
        }
        
        // Show Gmail authorization modal
        function showGmailAuthModal() {
            document.getElementById('gmailAuthModal').classList.remove('hidden');
            document.getElementById('gmailAuthModal').classList.add('flex');
        }
        
        // Hide Gmail authorization modal
        function hideGmailAuthModal() {
            document.getElementById('gmailAuthModal').classList.add('hidden');
            document.getElementById('gmailAuthModal').classList.remove('flex');
        }
        
        // Function to update Gmail connection status in UI
        function updateGmailConnectionStatus(isConnected, email) {
            if (isConnected) {
                document.getElementById('gmailConnectedSection').classList.remove('hidden');
                document.getElementById('gmailNotConnectedSection').classList.add('hidden');
                document.getElementById('connectedEmail').textContent = email || 'your Gmail account';
            } else {
                document.getElementById('gmailConnectedSection').classList.add('hidden');
                document.getElementById('gmailNotConnectedSection').classList.remove('hidden');
            }
        }
        
        // Function to check Gmail connection status from the server
        async function checkGmailStatus() {
            try {
                const response = await fetch(`${BASE_URL}/api/users/gmail-status`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.gmailConnected) {
                        // Get user profile to get the email
                        const profileResponse = await fetch(`${BASE_URL}/api/users/profile`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });
                        
                        if (profileResponse.ok) {
                            const profileData = await profileResponse.json();
                            updateGmailConnectionStatus(true, profileData.user.email);
                            
                            // Show emails section if connected
                            document.getElementById('emailsSection').classList.remove('hidden');
                            loadUserEmails();
                        }
                    } else {
                        updateGmailConnectionStatus(false);
                    }
                }
            } catch (error) {
                console.error('Error checking Gmail status:', error);
            }
        }
        
        // Function to load user's analyzed emails
        async function loadUserEmails() {
            try {
                showLoading();
                
                const response = await fetch(`${BASE_URL}/api/users/emails`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const emailsContainer = document.getElementById('emailsList');
                    emailsContainer.innerHTML = '';
                    
                    if (data.emails.length === 0) {
                        emailsContainer.innerHTML = '<div class="text-center text-gray-400 py-8">No emails analyzed yet</div>';
                        return;
                    }
                    
                    // Render emails
                    data.emails.forEach(email => {
                        const emailItem = document.createElement('div');
                        emailItem.className = 'border border-gray-700 rounded-lg p-4 hover:bg-white/5 transition mb-4';
                        
                        // Set background color based on risk level
                        let riskBgClass = 'bg-green-900/20';
                        let riskTextClass = 'text-green-400';
                        
                        if (email.phishingRisk === 'Medium') {
                            riskBgClass = 'bg-yellow-900/20';
                            riskTextClass = 'text-yellow-400';
                        } else if (email.phishingRisk === 'High') {
                            riskBgClass = 'bg-orange-900/20';
                            riskTextClass = 'text-orange-400';
                        } else if (email.phishingRisk === 'Critical') {
                            riskBgClass = 'bg-red-900/20';
                            riskTextClass = 'text-red-400';
                        }
                        
                        const date = new Date(email.date).toLocaleString();
                        
                        emailItem.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-white font-medium">${email.subject || '(No Subject)'}</h3>
                                    <p class="text-gray-400 text-sm">From: ${email.from}</p>
                                    <p class="text-gray-400 text-sm">Date: ${date}</p>
                                </div>
                                <div class="${riskBgClass} px-3 py-1 rounded-full">
                                    <span class="${riskTextClass} text-sm font-medium">${email.phishingRisk} Risk</span>
                                </div>
                            </div>
                            <div class="mt-3 grid grid-cols-4 gap-2 text-center text-xs">
                                <div class="bg-gray-800 rounded p-2">
                                    <p class="text-gray-400">Header</p>
                                    <p class="text-white font-medium">${email.scores.header}</p>
                                </div>
                                <div class="bg-gray-800 rounded p-2">
                                    <p class="text-gray-400">Text</p>
                                    <p class="text-white font-medium">${email.scores.text}</p>
                                </div>
                                <div class="bg-gray-800 rounded p-2">
                                    <p class="text-gray-400">Metadata</p>
                                    <p class="text-white font-medium">${email.scores.metadata}</p>
                                </div>
                                <div class="bg-gray-800 rounded p-2">
                                    <p class="text-gray-400">Attachments</p>
                                    <p class="text-white font-medium">${email.scores.attachments}</p>
                                </div>
                            </div>
                            <div class="mt-3 text-right">
                                <span class="text-gray-400 text-sm">Total Score: <span class="text-white font-medium">${email.scores.total}</span></span>
                            </div>
                        `;
                        
                        emailsContainer.appendChild(emailItem);
                    });
                }
            } catch (error) {
                console.error('Error loading emails:', error);
            } finally {
                hideLoading();
            }
        }
        
        // Update UI based on Gmail connection status
        function updateGmailConnectionStatus(isConnected, email = '') {
            const statusElement = document.getElementById('emailConnectionStatus');
            
            if (isConnected) {
                statusElement.classList.remove('bg-yellow-600/20', 'border-yellow-600/30');
                statusElement.classList.add('bg-green-600/20', 'border-green-600/30');
                
                statusElement.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <div class="bg-green-500/20 p-3 rounded-full">
                            <i class="fas fa-check-circle text-green-400 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-1">Gmail Account Connected</h3>
                            <p class="text-gray-300 mb-2">Your account <span class="text-blue-300 font-medium" id="connectedEmail">${email}</span> is now protected.</p>
                            <div class="flex space-x-3">
                                <button id="disconnectGmailBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-xs font-medium transition duration-150 ease-in-out flex items-center">
                                    <i class="fas fa-unlink mr-1"></i> Disconnect
                                </button>
                                <button id="scanNowBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-xs font-medium transition duration-150 ease-in-out flex items-center">
                                    <i class="fas fa-search mr-1"></i> Scan Now
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners to new buttons
                document.getElementById('disconnectGmailBtn').addEventListener('click', disconnectGmail);
                document.getElementById('scanNowBtn').addEventListener('click', scanEmails);
                
                // Update user email in header
                document.getElementById('userEmail').textContent = email;
            } else {
                // Reset to disconnected state (default HTML)
                statusElement.classList.remove('bg-green-600/20', 'border-green-600/30');
                statusElement.classList.add('bg-yellow-600/20', 'border-yellow-600/30');
                
                statusElement.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <div class="bg-yellow-500/20 p-3 rounded-full">
                            <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-1">Email Account Not Connected</h3>
                            <p class="text-gray-300 mb-4">Connect your Gmail account to enable email phishing protection.</p>
                            <button id="connectGmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center">
                                <i class="fab fa-google mr-2"></i> Connect Gmail Account
                            </button>
                        </div>
                    </div>
                `;
                
                // Re-add event listener to connect button
                document.getElementById('connectGmailBtn').addEventListener('click', showGmailAuthModal);
            }
        }
        
        // Function to check Gmail connection status from the server
        async function checkGmailStatus() {
            try {
                const response = await fetch(`${BASE_URL}/api/users/gmail-status`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.gmailConnected) {
                        // Get user profile to get the email
                        const profileResponse = await fetch(`${BASE_URL}/api/users/profile`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });
                        
                        if (profileResponse.ok) {
                            const profileData = await profileResponse.json();
                            updateGmailConnectionStatus(true, profileData.user.email);
                            
                            // Show emails section if connected
                            document.getElementById('emailsSection').classList.remove('hidden');
                            loadUserEmails();
                        }
                    } else {
                        updateGmailConnectionStatus(false);
                    }
                }
            } catch (error) {
                console.error('Error checking Gmail status:', error);
            }
        }
        
        // Enhanced Gmail connection function with better error handling
        async function connectGmail() {
            hideGmailAuthModal();
            showLoading();
            
            try {
                // Get auth token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found. Please log in again.');
                }
                
                // Get the OAuth URL from our backend
                const response = await fetch(`${BASE_URL}/api/gmail/auth-url`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Handle HTTP errors
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Authentication failed. Please log in again.');
                } else if (response.status === 404) {
                    throw new Error('Gmail API endpoint not found. The server might be misconfigured.');
                } else if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Server error: ${errorData.message || response.statusText || 'Unknown error'}`);
                }
                
                const data = await response.json();
                
                if (!data.authUrl) {
                    throw new Error('Invalid response from server: Missing authentication URL');
                }
                
                // Store current page URL to return after auth
                localStorage.setItem('gmailAuthReturnUrl', window.location.href);
                
                // Redirect to Google OAuth consent screen
                window.location.href = data.authUrl;
                
            } catch (error) {
                hideLoading();
                
                // Provide helpful error messages based on error type
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showError('Network Error', 'Cannot connect to the server. Please check your internet connection and try again.');
                } else {
                    showError('Gmail Connection Error', error.message);
                }
            }
        }
        
        // Enhanced function to disconnect Gmail with better error handling
        async function disconnectGmail() {
            showLoading();
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found. Please log in again.');
                }
                
                // Call the disconnect endpoint
                const response = await fetch(`${BASE_URL}/api/gmail/disconnect`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Handle HTTP errors
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Authentication failed. Please log in again.');
                } else if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Server error: ${errorData.message || response.statusText || 'Unknown error'}`);
                }
                
                // Update UI
                updateGmailConnectionStatus(false);
                
                // Remove Gmail connection from localStorage
                localStorage.removeItem('gmailConnected');
                localStorage.removeItem('gmailEmail');
                
                hideLoading();
                showSuccessNotification('Gmail Disconnected', 'Your Gmail account has been successfully disconnected.');
            } catch (error) {
                console.error('Gmail disconnection error:', error);
                hideLoading();
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showError('Network Error', 'Cannot connect to the server. Please check your internet connection and try again.');
                } else {
                    showError('Gmail Disconnection Error', error.message);
                }
            }
        }
        
        // Function to handle OAuth callback
        function handleGmailOAuthCallback() {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                // Handle OAuth error
                showError('Gmail Authorization Failed', `Error: ${error}`);
                return;
            }
            
            if (code) {
                // Exchange the code for tokens
                exchangeCodeForTokens(code);
            }
        }
        
        // Function to exchange authorization code for tokens
        async function exchangeCodeForTokens(code) {
            showLoading();
            
            try {
                const BASE_URL = getBaseUrl();
                const token = localStorage.getItem('token');
                
                if (!token) {
                    throw new Error('Authentication token not found. Please log in again.');
                }
                
                // Call backend to exchange code for tokens
                const response = await fetch(`${BASE_URL}/api/gmail/oauth-callback`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });
                
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Authentication failed. Please log in again.');
                } else if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Server error: ${errorData.message || response.statusText || 'Unknown error'}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Store Gmail connection status
                    localStorage.setItem('gmailConnected', 'true');
                    
                    // Get user email if available
                    if (data.email) {
                        localStorage.setItem('gmailEmail', data.email);
                    }
                    
                    // Update UI
                    updateGmailConnectionStatus(true, data.email || localStorage.getItem('userEmail'));
                    
                    // Show success message
                    showSuccessNotification('Gmail Connected Successfully', 'Your Gmail account is now connected and protected.');
                    
                    // If we have a return URL, redirect back
                    const returnUrl = localStorage.getItem('gmailAuthReturnUrl');
                    if (returnUrl) {
                        localStorage.removeItem('gmailAuthReturnUrl');
                        window.location.href = returnUrl;
                    }
                } else {
                    throw new Error(data.message || 'Failed to connect Gmail account');
                }
            } catch (error) {
                showError('Gmail Connection Error', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Function to scan emails
        async function scanEmails() {
            showLoading();
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                hideLoading();
                alert('Email scan completed. No phishing threats detected.');
            } catch (error) {
                console.error('Email scan error:', error);
                hideLoading();
                alert('Failed to scan emails. Please try again.');
            }
        }

        // Check if user is authenticated
        async function checkAuth() {
            try {
                // First check the userRole
                const userRole = localStorage.getItem('userRole');
                const token = localStorage.getItem('token');
                
                console.log('Checking auth status - Role:', userRole, 'Token exists:', !!token);
                
                // If user is an admin, they should be on admin dashboard
                if (userRole === 'admin' && token) {
                    console.log('Admin user detected, redirecting to admin dashboard');
                    window.location.href = '/admin-dashboard.html';
                    return;
                }
                
                // For regular users, continue with standard auth check
                if (token) {
                    console.log('Found token in localStorage');
                    
                    // Verify the token is valid
                    try {
                        const response = await fetch(`${BASE_URL}/auth/check-auth`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Auth check response:', data);
                            
                            // If user is admin, redirect to admin dashboard
                            if (data.user && data.user.role === 'admin') {
                                localStorage.setItem('userRole', 'admin');
                                window.location.href = '/admin-dashboard.html';
                                return;
                            }
                            
                            // User token is valid, stay on user dashboard
                            localStorage.setItem('userRole', 'user');
                            
                            // If we have user data, update the email display
                            if (data.user && data.user.email) {
                                document.getElementById('userEmail').textContent = data.user.email;
                                localStorage.setItem('userEmail', data.user.email);
                            }
                            
                            return;
                        } else {
                            // Token is invalid
                            console.log('Token validation failed');
                            localStorage.removeItem('token');
                            localStorage.removeItem('userRole');
                        }
                    } catch (verifyError) {
                        console.error('Error verifying token:', verifyError);
                    }
                }
                
                // If no token in localStorage or validation failed, check with server cookies
                console.log('Checking with server cookies...');
                const cookieResponse = await fetch(`${BASE_URL}/auth/check-auth`, {
                    method: 'GET',
                    credentials: 'include' // Send cookies
                });
                
                if (cookieResponse.ok) {
                    // User is authenticated via cookies
                    const data = await cookieResponse.json();
                    console.log('Cookie auth check response:', data);
                    
                    // Store the token if provided
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                    }
                    
                    // If user is admin, redirect to admin dashboard
                    if (data.user && data.user.role === 'admin') {
                        localStorage.setItem('userRole', 'admin');
                        window.location.href = '/admin-dashboard.html';
                        return;
                    }
                    
                    // Otherwise stay on user dashboard
                    localStorage.setItem('userRole', 'user');
                    
                    // If we have user data, update the email display
                    if (data.user && data.user.email) {
                        document.getElementById('userEmail').textContent = data.user.email;
                        localStorage.setItem('userEmail', data.user.email);
                    }
                    
                    return;
                }
                
                // If neither method authenticated the user, redirect to login
                console.log('Not authenticated, redirecting to login');
                window.location.href = `${BASE_URL}/login.html`;
            } catch (error) {
                console.error('Auth check error:', error);
                // Don't redirect immediately on error
                // The server might be temporarily unavailable
            }
        }

        // Initialize the page with enhanced Gmail authentication
        function initializePage() {
            // Check if this is an OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') || urlParams.has('error')) {
                handleGmailOAuthCallback();
                return; // Don't proceed with normal initialization during OAuth callback
            }
            
            // Check Gmail connection status from localStorage
            const isGmailConnected = localStorage.getItem('gmailConnected') === 'true';
            const userEmail = localStorage.getItem('gmailEmail') || localStorage.getItem('userEmail') || '';
            
            // Update UI based on connection status
            updateGmailConnectionStatus(isGmailConnected, userEmail);
            
            // If connected, show emails section
            if (isGmailConnected) {
                const emailsSection = document.getElementById('emailsSection');
                if (emailsSection) {
                    emailsSection.classList.remove('hidden');
                    loadUserEmails();
                }
            }
            
            // Event listeners for Gmail connection
            const connectBtn = document.getElementById('connectGmailBtn');
            if (connectBtn) {
                connectBtn.addEventListener('click', showGmailAuthModal);
            }
            
            // Modal event listeners
            document.getElementById('closeModal')?.addEventListener('click', hideGmailAuthModal);
            document.getElementById('authorizeGmailBtn')?.addEventListener('click', connectGmail);
            document.getElementById('cancelGmailAuthBtn')?.addEventListener('click', hideGmailAuthModal);
            
            // Also check with server for Gmail connection status
            checkGmailStatus().catch(err => console.error('Error checking Gmail status:', err));
        }

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                showLoading();
                const response = await fetch(`${BASE_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('userRole');
                    // Don't remove Gmail connection status to persist it between sessions
                    window.location.href = `${BASE_URL}/login.html`;
                } else {
                    console.error('Logout failed');
                    hideLoading();
                }
            } catch (error) {
                console.error('Logout error:', error);
                hideLoading();
            }
        });

        // Check authentication when page loads
        checkAuth();
        
        // Check Gmail connection status when page loads
        checkGmailStatus();
        
        // Initialize the page after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>